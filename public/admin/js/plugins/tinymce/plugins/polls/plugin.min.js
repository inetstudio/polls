$('#add_poll_modal .create-poll').on('click', function (event) {
    event.preventDefault();

    $('#add_poll_modal').modal('hide');
    $('#poll_modal').modal();
});

$('#add_poll_modal .save').on('click', function (event) {
    event.preventDefault();

    var option = $("#add_poll_modal option:selected"),
        editor = $(this).attr('data-editor'),
        title = option.text(),
        id = option.val();

    if (id != '') {
        tinymce.get(editor).editorManager.execCommand('mceInsertContent', false, '<img class="content-widget" data-type="poll" data-id="'+id+'" alt="Виджет-опрос: '+title+'" style="height: 100px; width: 100%; border: 1px red solid;" />');
    }

    $('#add_poll_modal').modal('hide');
});

$('#poll_modal .save').on('click', function (event) {
    event.preventDefault();

    var form = $('#poll_modal form'),
        editor = $(this).attr('data-editor'),
        data = form.serialize();

    $.ajax({
        'url': form.attr('action'),
        'type': form.attr('method'),
        'data': data,
        'dataType': 'json',
        'success': function (data) {
            if (data.success == true) {
                $('#poll_modal').modal('hide');

                if ($('#poll_modal input[name=poll_id]').val() != '') {
                    swal({
                        title: "Опрос отредактирован",
                        type: "success"
                    });

                    tinyMCE.get(editor).selection.setContent('<img class="content-widget" data-type="poll" data-id="'+data.id+'" alt="Виджет-опрос: '+data.title+'" style="height: 100px; width: 100%; border: 1px red solid;" />')
                } else {
                    swal({
                        title: "Опрос создан",
                        type: "success"
                    });

                    tinymce.get(editor).editorManager.execCommand('mceInsertContent', false, '<img class="content-widget" data-type="poll" data-id="'+data.id+'" alt="Виджет-опрос: '+data.title+'" style="height: 100px; width: 100%; border: 1px red solid;" />');
                }
            }
        },
        'error': function () {
            swal({
                title: "Ошибка",
                text: "При создании опроса произошла ошибка",
                type: "error"
            });
        }
    });
});

tinymce.PluginManager.add('polls', function (editor) {
    editor.addButton('polls', {
        title: 'Опросы',
        image: '/admin/img/polls.png',
        onclick: function() {
            var content = tinyMCE.get(editor.id).selection.getContent();

            if (content != '' && ! /<img class="content-widget".+data-type="poll".+\/>/g.test(content)) {
                swal({
                    title: "Ошибка",
                    text: "Необходимо выбрать виджет-опрос",
                    type: "error"
                });

                return false;
            } else if (content != '') {
                var pollID = $(content).attr('data-id');

                $.ajax({
                    url: '/back/polls/info',
                    type: 'POST',
                    data: {
                        _token: $('meta[name="csrf-token"]').attr('content'),
                        id: pollID
                    },
                    dataType: 'json',
                    success: function (data) {
                        if (data.success == true) {
                            $('#poll_modal .modal-header h1').text('Редактирование опроса');
                            $('#poll_modal form').attr('action', '/back/polls/' + data.id);
                            $('#poll_modal input[name=_method]').val('PUT');
                            $('#poll_modal input[name=poll_id]').val(data.id);
                            $('#poll_modal input[name=question]').val(data.question);
                            Admin.containers.lists['options_field_block'].items = data.options;
                            $('#poll_modal .save').attr('data-editor', editor.id)

                            $('#poll_modal').modal();
                        }
                    },
                    error: function () {
                        swal({
                            title: "Ошибка",
                            text: "При получении опроса произошла ошибка",
                            type: "error"
                        });
                    }
                });
            } else {
                $('#poll_modal .modal-header h1').text('Создание опроса');
                $('#poll_modal form').attr('action', '/back/polls/');
                $('#poll_modal input[name=_method]').val('POST');
                $('#poll_modal input[name=poll_id]').val('');
                $('#poll_modal input[name=question]').val('');
                Admin.containers.lists['options_field_block'].items = [];
                $('#poll_modal .save').attr('data-editor', editor.id)

                $('#add_poll_modal .save').attr('data-editor', editor.id)
                $('#add_poll_modal select.select2').val('');
                $('#add_poll_modal select.select2').trigger('change');
                $('#add_poll_modal').modal();
            }
        }
    })
})
